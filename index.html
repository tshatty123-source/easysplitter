<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Easy Splitter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #f4f6fb;
      margin: 0;
      padding: 0;
    }

    header {
      background: #4f46e5;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }

    .container {
      max-width: 420px;
      margin: auto;
      padding: 16px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
    }

    button {
      background: #4f46e5;
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111;
    }

    .hidden {
      display: none;
    }

    .group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }

    .group button {
      width: auto;
      padding: 6px 12px;
      font-size: 14px;
    }

    .small {
      font-size: 14px;
      color: #555;
    }
  </style>
</head>

<body>

<header>Easy Splitter</header>

<div class="container">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <p class="small">Split expenses with friends in real-time.</p>
    <button id="loginBtn">Sign in with Google</button>
  </div>

  <!-- USER -->
  <div class="card hidden" id="userCard">
    <p id="userName"></p>
    <button class="secondary" id="logoutBtn">Logout</button>
  </div>

  <!-- CREATE GROUP -->
  <div class="card hidden" id="createGroupCard">
    <h3>Create Group</h3>
    <input id="groupName" placeholder="Group name" />
    <button id="createGroupBtn">Create</button>
  </div>

  <!-- GROUP LIST -->
  <div class="card hidden" id="groupsCard">
    <h3>Your Groups</h3>
    <div id="groupsList"></div>
  </div>

  <!-- GROUP DETAILS -->
  <div class="card hidden" id="groupDetailsCard">
    <h3 id="currentGroupName"></h3>

    <input id="paymentDesc" placeholder="What did you pay for?" />
    <input id="paymentAmount" type="number" placeholder="Amount" />
    <button id="addPaymentBtn">Add Payment</button>

    <h4>Payments</h4>
    <div id="paymentsList" class="small"></div>
  </div>

</div>

<script type="module">
  // ðŸ”¥ Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // ðŸ” Firebase config (YOURS)
  const firebaseConfig = {
    apiKey: "AIzaSyD9cLdPpXUoPwZKb8yH8D0i867xZwf3Pww",
    authDomain: "easysplitter-c5a4c.firebaseapp.com",
    projectId: "easysplitter-c5a4c",
    storageBucket: "easysplitter-c5a4c.firebasestorage.app",
    messagingSenderId: "582888920406",
    appId: "1:582888920406:web:1d80e0b7b952f97ce9b2f7"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let currentGroup = null;
  let groupUnsubscribe = null;

  // Elements
  const loginCard = document.getElementById("loginCard");
  const userCard = document.getElementById("userCard");
  const createGroupCard = document.getElementById("createGroupCard");
  const groupsCard = document.getElementById("groupsCard");
  const groupDetailsCard = document.getElementById("groupDetailsCard");

  // Auth
  document.getElementById("loginBtn").onclick = () =>
    signInWithPopup(auth, provider);

  document.getElementById("logoutBtn").onclick = () =>
    signOut(auth);

  onAuthStateChanged(auth, user => {
    if (!user) {
      loginCard.classList.remove("hidden");
      userCard.classList.add("hidden");
      createGroupCard.classList.add("hidden");
      groupsCard.classList.add("hidden");
      return;
    }

    currentUser = user;
    document.getElementById("userName").innerText = "Hi, " + user.displayName;

    loginCard.classList.add("hidden");
    userCard.classList.remove("hidden");
    createGroupCard.classList.remove("hidden");
    groupsCard.classList.remove("hidden");

    loadGroups();
  });

  // Create group
  document.getElementById("createGroupBtn").onclick = async () => {
    const name = document.getElementById("groupName").value.trim();
    if (!name) return alert("Enter group name");

    await addDoc(collection(db, "groups"), {
      name,
      members: [currentUser.uid]
    });

    document.getElementById("groupName").value = "";
  };

  // Load groups
  function loadGroups() {
    const q = query(
      collection(db, "groups"),
      where("members", "array-contains", currentUser.uid)
    );

    onSnapshot(q, snap => {
      const list = document.getElementById("groupsList");
      list.innerHTML = "";

      snap.forEach(docu => {
        const g = docu.data();
        const div = document.createElement("div");
        div.className = "group";
        div.innerHTML = `
          <span>${g.name}</span>
          <button onclick="openGroup('${docu.id}')">Open</button>
        `;
        list.appendChild(div);
      });
    });
  }

  // ðŸ”¥ FIXED open group
  window.openGroup = (id) => {
    if (groupUnsubscribe) groupUnsubscribe();

    const ref = doc(db, "groups", id);
    groupUnsubscribe = onSnapshot(ref, snap => {
      currentGroup = { id: snap.id, ...snap.data() };
      document.getElementById("currentGroupName").innerText = currentGroup.name;
      groupDetailsCard.classList.remove("hidden");
    });
  };

  // Add payment
  document.getElementById("addPaymentBtn").onclick = async () => {
    if (!currentGroup) return;

    const desc = document.getElementById("paymentDesc").value;
    const amt = Number(document.getElementById("paymentAmount").value);

    if (!desc || !amt) return alert("Enter details");

    await addDoc(collection(db, "groups", currentGroup.id, "payments"), {
      desc,
      amount: amt,
      paidBy: currentUser.displayName,
      uid: currentUser.uid,
      time: Date.now()
    });

    document.getElementById("paymentDesc").value = "";
    document.getElementById("paymentAmount").value = "";
  };

  // Payments listener
  onSnapshot(collection(db, "groups"), () => {
    if (!currentGroup) return;

    onSnapshot(
      collection(db, "groups", currentGroup.id, "payments"),
      snap => {
        const list = document.getElementById("paymentsList");
        list.innerHTML = "";
        snap.forEach(p => {
          const d = p.data();
          list.innerHTML += `<div>${d.paidBy}: â‚¹${d.amount} (${d.desc})</div>`;
        });
      }
    );
  });

</script>

</body>
</html>

