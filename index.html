<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Easy Splitter</title>

<!-- Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body{
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:#f4f6fb;
  color:#111;
}
.hidden{display:none}
header{
  background:#4f46e5;
  color:white;
  padding:16px;
  text-align:center;
}
.container{
  max-width:420px;
  margin:auto;
  padding:16px;
}
.card{
  background:white;
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 8px 18px rgba(0,0,0,.08);
}
input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  font-size:15px;
}
input{border:1px solid #ddd}
button{
  border:none;
  background:#4f46e5;
  color:white;
  font-weight:600;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
button.secondary{background:#e5e7eb;color:#111}
button.pay{background:#16a34a}
.item{
  padding:12px;
  background:#f1f5f9;
  border-radius:12px;
  margin-top:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.item.owe{border-left:5px solid #ef4444}
.item.receive{border-left:5px solid #22c55e}
.small{font-size:13px;color:#555}
.alert{
  padding:10px;
  border-radius:10px;
  margin-bottom:12px;
}
.success{background:#dcfce7;color:#166534}
.error{background:#fee2e2;color:#991b1b}
</style>
</head>

<body>
<header>
  <h2>Easy Splitter</h2>
  <p class="small">Split â€¢ Track â€¢ Settle â€¢ Simple</p>
</header>

<div class="container">
<div id="alert"></div>

<!-- LOGIN -->
<div id="login" class="card">
  <p>Sign in to start splitting expenses.</p>
  <button id="loginBtn">
    <span class="material-icons">login</span>
    Sign in with Google
  </button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">
  <div class="card">
    <p id="userName"></p>
    <input id="upiInput" placeholder="Your UPI ID (optional)">
    <button class="secondary" id="saveUpi">
      <span class="material-icons">payment</span> Save UPI
    </button>
  </div>

  <div class="card">
    <button onclick="showCreate()">
      <span class="material-icons">group_add</span> Create Group
    </button>
    <button onclick="showJoin()" class="secondary">
      <span class="material-icons">link</span> Join Group
    </button>
  </div>

  <div class="card">
    <h4>Your Groups</h4>
    <div id="groups"></div>
  </div>

  <button class="secondary" id="logoutBtn">
    <span class="material-icons">logout</span> Logout
  </button>
</div>

<!-- CREATE GROUP -->
<div id="createGroup" class="card hidden">
  <h3>Create Group</h3>
  <input id="groupName" placeholder="Group name">
  <button id="createBtn">Create</button>
  <button class="secondary" onclick="back()">Back</button>
</div>

<!-- JOIN GROUP -->
<div id="joinGroup" class="card hidden">
  <h3>Join Group</h3>
  <input id="joinInput" placeholder="Paste group ID or link">
  <button id="joinBtn">Join</button>
  <button class="secondary" onclick="back()">Back</button>
</div>

<!-- GROUP PAGE -->
<div id="groupPage" class="card hidden">
  <h3 id="groupTitle"></h3>

  <input id="amount" type="number" placeholder="Amount you paid">
  <button id="addPayment">Add Payment</button>

  <h4>Invite</h4>
  <div id="invite"></div>

  <h4>Payments</h4>
  <div id="payments"></div>

  <h4>Balances</h4>
  <div id="balances"></div>

  <button class="secondary" onclick="back()">Back</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, onSnapshot, query, where, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ðŸ”¥ YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyD9cLdPpXUoPwZKb8yH8D0i867xZwf3Pww",
  authDomain: "easysplitter-c5a4c.firebaseapp.com",
  projectId: "easysplitter-c5a4c",
  storageBucket: "easysplitter-c5a4c.appspot.com",
  messagingSenderId: "582888920406",
  appId: "1:582888920406:web:1d80e0b7b952f97ce9b2f7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let user=null, activeGroup=null;

const pages=["login","dashboard","createGroup","joinGroup","groupPage"];
const show=p=>pages.forEach(x=>document.getElementById(x).classList.add("hidden"))||document.getElementById(p).classList.remove("hidden");

const alertMsg=(m,t="success")=>{
  alert.innerHTML=`<div class="alert ${t}">${m}</div>`;
  setTimeout(()=>alert.innerHTML="",3000);
};

loginBtn.onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());
logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,async u=>{
  if(!u){show("login");return;}
  user=u;
  userName.innerText=u.displayName;
  await setDoc(doc(db,"users",u.uid),{name:u.displayName},{merge:true});
  loadGroups();
  show("dashboard");
});

saveUpi.onclick=()=>updateDoc(doc(db,"users",user.uid),{upi:upiInput.value});

function showCreate(){show("createGroup")}
function showJoin(){show("joinGroup")}
function back(){show("dashboard")}

createBtn.onclick=async()=>{
  if(!groupName.value)return alertMsg("Enter group name","error");
  const g=await addDoc(collection(db,"groups"),{
    name:groupName.value,
    members:[user.uid],
    created:Date.now()
  });
  openGroup(g.id,groupName.value);
};

joinBtn.onclick=async()=>{
  let id=joinInput.value;
  if(id.includes("group=")) id=id.split("group=")[1];
  const g=await getDoc(doc(db,"groups",id));
  if(!g.exists()) return alertMsg("Group not found","error");
  await updateDoc(doc(db,"groups",id),{members:arrayUnion(user.uid)});
  openGroup(id,g.data().name);
};

function loadGroups(){
  const q=query(collection(db,"groups"),where("members","array-contains",user.uid));
  onSnapshot(q,s=>{
    groups.innerHTML="";
    s.forEach(d=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`${d.data().name}<button class="secondary" onclick="openGroup('${d.id}','${d.data().name}')">Open</button>`;
      groups.appendChild(div);
    });
  });
}

window.openGroup=(id,name)=>{
  activeGroup=id;
  groupTitle.innerText=name;
  invite.innerText=location.href+"?group="+id;
  show("groupPage");
  loadPayments();
};

addPayment.onclick=()=>addDoc(collection(db,"groups",activeGroup,"payments"),{
  uid:user.uid,
  name:user.displayName,
  amount:+amount.value,
  time:Date.now()
});

function loadPayments(){
  onSnapshot(collection(db,"groups",activeGroup,"payments"),snap=>{
    payments.innerHTML=""; balances.innerHTML="";
    let total=0, mine=0;
    snap.forEach(d=>{
      const p=d.data(); total+=p.amount;
      if(p.uid===user.uid) mine+=p.amount;
      payments.innerHTML+=`<div class="item">${p.name} â‚¹${p.amount}</div>`;
    });
    const share=total/(snap.size||1);
    const bal=mine-share;
    balances.innerHTML=bal>0
      ? `<div class="item receive">You receive â‚¹${bal.toFixed(2)}</div>`
      : `<div class="item owe">You owe â‚¹${Math.abs(bal).toFixed(2)}</div>`;
  });
}
</script>
</body>
</html>
