<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Easy Splitter</title>

<style>
body{margin:0;font-family:system-ui;background:#f5f7fb}
.hidden{display:none}
header{background:#4f46e5;color:#fff;padding:14px;font-size:18px}
main{max-width:480px;margin:auto;padding:16px}
.card{background:#fff;padding:14px;border-radius:14px;margin:12px 0}
button,input{width:100%;padding:12px;margin:8px 0;border-radius:10px;border:1px solid #ddd}
button{background:#4f46e5;color:#fff;border:none}
.secondary{background:#e5e7eb;color:#111}
.group{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
.settle{background:#f1f5f9;padding:10px;border-radius:10px;margin:6px 0}
.pay{display:block;background:#16a34a;color:#fff;padding:8px;text-align:center;border-radius:8px;margin-top:6px}
</style>
</head>

<body>
<header>Easy Splitter</header>
<main>

<section id="dashboard">
  <div class="card">
    <b>Welcome</b>
    <p id="userInfo"></p>
  </div>

  <button onclick="showCreate()">âž• Create Group</button>
  <button class="secondary" onclick="showJoin()">ðŸ”— Join Group</button>

  <div class="card">
    <b>My Groups</b>
    <div id="groups"></div>
  </div>
</section>

<section id="createGroup" class="hidden">
  <input id="groupName" placeholder="Group name">
  <input id="upiId" placeholder="Your UPI ID">
  <button onclick="createGroup()">Create</button>
  <button class="secondary" onclick="back()">Back</button>
</section>

<section id="joinGroup" class="hidden">
  <input id="joinCode" placeholder="Invite code">
  <button onclick="joinGroup()">Join</button>
  <button class="secondary" onclick="back()">Back</button>
</section>

<section id="groupPage" class="hidden">
  <h3 id="groupTitle"></h3>

  <div class="card">
    <input id="amount" type="number" placeholder="Amount paid">
    <button onclick="addPayment()">Add Payment</button>
  </div>

  <div class="card">
    <b>Balances</b>
    <div id="balances"></div>
  </div>

  <div class="card">
    <b>Settle</b>
    <div id="settlements"></div>
  </div>

  <div class="card">
    <b>Invite</b>
    <p id="invite"></p>
  </div>

  <button class="secondary" onclick="back()">Back</button>
</section>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD9cLdPpXUoPwZKb8yH8D0i867xZwf3Pww",
  authDomain: "easysplitter-c5a4c.firebaseapp.com",
  projectId: "easysplitter-c5a4c",
  storageBucket: "easysplitter-c5a4c.firebasestorage.app",
  appId: "1:582888920406:web:1d80e0b7b952f97ce9b2f7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let user, activeGroup;

signInAnonymously(auth);

onAuthStateChanged(auth, u => {
  user = u;
  userInfo.innerText = "User ID: " + u.uid.slice(0,6);
  loadGroups();
});

function show(id){
  document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}
window.showCreate=()=>show("createGroup");
window.showJoin=()=>show("joinGroup");
window.back=()=>show("dashboard");

async function loadGroups(){
  const snap = await getDocs(collection(db,"groups"));
  groups.innerHTML="";
  snap.forEach(d=>{
    if(d.data().members?.includes(user.uid)){
      const div=document.createElement("div");
      div.className="group";
      div.innerText=d.data().name;
      div.onclick=()=>openGroup(d.id,d.data().name);
      groups.appendChild(div);
    }
  });
}

window.createGroup = async ()=>{
  if(!groupName.value) return alert("Enter name");
  const ref = await addDoc(collection(db,"groups"),{
    name:groupName.value,
    upi:upiId.value,
    members:[user.uid]
  });
  openGroup(ref.id,groupName.value);
};

window.joinGroup = async ()=>{
  const ref = doc(db,"groups",joinCode.value);
  const snap = await getDoc(ref);
  if(!snap.exists()) return alert("Invalid code");
  await updateDoc(ref,{members:[...new Set([...(snap.data().members||[]),user.uid])]});
  openGroup(ref.id,snap.data().name);
};

window.openGroup = async (id,name)=>{
  activeGroup=id;
  groupTitle.innerText=name;
  invite.innerText=location.origin+"?group="+id;
  show("groupPage");
  loadBalances();
};

window.addPayment = async ()=>{
  if(!amount.value) return alert("Amount?");
  await addDoc(collection(db,"groups",activeGroup,"payments"),{
    uid:user.uid,
    amount:+amount.value
  });
  amount.value="";
  loadBalances();
};

async function loadBalances(){
  const snap=await getDocs(collection(db,"groups",activeGroup,"payments"));
  let sum=0,totals={};
  snap.forEach(d=>{
    totals[d.data().uid]=(totals[d.data().uid]||0)+d.data().amount;
    sum+=d.data().amount;
  });
  const members=Object.keys(totals);
  const share=sum/members.length;
  balances.innerHTML="";
  const bal={};
  members.forEach(m=>{
    bal[m]=totals[m]-share;
    balances.innerHTML+=`<div>${m.slice(0,6)}: â‚¹${bal[m].toFixed(2)}</div>`;
  });
  renderSettlements(bal);
}

function renderSettlements(b){
  settlements.innerHTML="";
  const debt=[],cred=[];
  Object.entries(b).forEach(([u,v])=>v<0?debt.push([u,-v]):v>0&&cred.push([u,v]));
  debt.forEach(d=>{
    cred.forEach(c=>{
      if(d[1]>0 && c[1]>0){
        const pay=Math.min(d[1],c[1]);
        d[1]-=pay;c[1]-=pay;
        settlements.innerHTML+=`
          <div class="settle">
            ${d[0].slice(0,6)} pays ${c[0].slice(0,6)} â‚¹${pay.toFixed(2)}
          </div>`;
      }
    });
  });
}
</script>
</body>
</html>
