<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Easy Splitter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
header{background:#4f46e5;color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:700}
.container{max-width:430px;margin:auto;padding:16px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
h3,h4{margin:8px 0}
.small{font-size:14px;color:#555}
input,button{width:100%;padding:12px;margin-top:8px;border-radius:12px;border:1px solid #ddd;font-size:15px}
button{background:#4f46e5;color:#fff;border:none;font-weight:600}
button.secondary{background:#e5e7eb;color:#111}
button.pay{background:#16a34a}
button.warn{background:#f59e0b}
.hidden{display:none}
.notice{padding:10px;border-radius:10px;margin-bottom:12px;font-size:14px}
.success{background:#dcfce7;color:#166534}
.error{background:#fee2e2;color:#991b1b}
.group{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.group button{width:auto;padding:6px 12px}
.balance{background:#f1f5f9;padding:10px;border-radius:10px;margin-top:8px}
.status{font-size:13px;margin-top:6px}
</style>
</head>

<body>
<header>ðŸ’¸ Easy Splitter</header>

<div class="container">
<div id="notice"></div>

<div class="card" id="loginCard">
  <p class="small">Split expenses, settle with trust.</p>
  <button id="loginBtn">Sign in with Google</button>
</div>

<div class="card hidden" id="userCard">
  <p id="userName"></p>
  <input id="upiInput" placeholder="Your UPI ID (e.g. name@upi)">
  <button id="saveUpiBtn" class="secondary">Save UPI</button>
  <button id="logoutBtn" class="secondary">Logout</button>
</div>

<div class="card hidden" id="createGroupCard">
  <h3>Create Group</h3>
  <input id="groupName" placeholder="Trip / Flat / Party">
  <button id="createGroupBtn">Create</button>
</div>

<div class="card hidden" id="groupsCard">
  <h3>Your Groups</h3>
  <div id="groupsList"></div>
</div>

<div class="card hidden" id="groupDetailsCard">
  <h3 id="currentGroupName"></h3>

  <h4>Add Payment</h4>
  <input id="paymentDesc" placeholder="Description">
  <input id="paymentAmount" type="number" placeholder="Amount â‚¹">
  <button id="addPaymentBtn">Add Payment</button>

  <h4>Balances & Settlement</h4>
  <div id="balancesList"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyD9cLdPpXUoPwZKb8yH8D0i867xZwf3Pww",
 authDomain:"easysplitter-c5a4c.firebaseapp.com",
 projectId:"easysplitter-c5a4c",
 storageBucket:"easysplitter-c5a4c.firebasestorage.app",
 messagingSenderId:"582888920406",
 appId:"1:582888920406:web:1d80e0b7b952f97ce9b2f7"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

let currentUser=null,currentGroup=null;

const notice=(m,t="success")=>{
 document.getElementById("notice").innerHTML=`<div class="notice ${t}">${m}</div>`;
 setTimeout(()=>document.getElementById("notice").innerHTML="",3000);
};

loginBtn.onclick=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,async u=>{
 if(!u) return;
 currentUser=u;
 loginCard.classList.add("hidden");
 userCard.classList.remove("hidden");
 createGroupCard.classList.remove("hidden");
 groupsCard.classList.remove("hidden");
 userName.innerText="ðŸ‘‹ "+u.displayName;

 await setDoc(doc(db,"users",u.uid),{name:u.displayName,email:u.email},{merge:true});
 loadGroups();
});

saveUpiBtn.onclick=async()=>{
 if(!upiInput.value.trim()) return notice("Enter valid UPI","error");
 await updateDoc(doc(db,"users",currentUser.uid),{upi:upiInput.value});
 notice("UPI saved");
};

createGroupBtn.onclick=async()=>{
 if(!groupName.value) return notice("Group name required","error");
 await addDoc(collection(db,"groups"),{name:groupName.value,members:[currentUser.uid]});
 groupName.value="";
};

function loadGroups(){
 const q=query(collection(db,"groups"),where("members","array-contains",currentUser.uid));
 onSnapshot(q,s=>{
  groupsList.innerHTML="";
  s.forEach(d=>{
   groupsList.innerHTML+=`
   <div class="group">
    <span>${d.data().name}</span>
    <button onclick="openGroup('${d.id}')">Open</button>
   </div>`;
  });
 });
}

window.openGroup=(id)=>{
 onSnapshot(doc(db,"groups",id),snap=>{
  currentGroup={id:snap.id,...snap.data()};
  currentGroupName.innerText=currentGroup.name;
  groupDetailsCard.classList.remove("hidden");
  listenPayments();
 });
};

addPaymentBtn.onclick=async()=>{
 if(!paymentDesc.value||!paymentAmount.value) return notice("Enter payment","error");
 await addDoc(collection(db,"groups",currentGroup.id,"payments"),{
  uid:currentUser.uid,
  name:currentUser.displayName,
  desc:paymentDesc.value,
  amount:Number(paymentAmount.value),
  time:Date.now()
 });
 paymentDesc.value=paymentAmount.value="";
};

function listenPayments(){
 onSnapshot(collection(db,"groups",currentGroup.id,"payments"),snap=>{
  const totals={};
  snap.forEach(p=>{
   const d=p.data();
   totals[d.uid]=(totals[d.uid]||0)+d.amount;
  });
  calculateBalances(totals);
 });
}

function calculateBalances(totals){
 const members=currentGroup.members;
 const total=Object.values(totals).reduce((a,b)=>a+b,0);
 const share=total/members.length;
 balancesList.innerHTML="";
 members.forEach(uid=>{
  const diff=(totals[uid]||0)-share;
  if(uid!==currentUser.uid && diff<0){
   balancesList.innerHTML+=`
   <div class="balance">
    You owe â‚¹${Math.abs(diff).toFixed(2)}
    <button class="pay" onclick="requestSettlement('${uid}',${Math.abs(diff)})">Pay via UPI</button>
   </div>`;
  }
 });
}

window.requestSettlement=async(to,amt)=>{
 const snap=await fetchUser(to);
 const upi=snap.upi||"";
 window.location.href=`upi://pay?pa=${upi}&pn=EasySplitter&am=${amt}`;
 await addDoc(collection(db,"groups",currentGroup.id,"settlements"),{
  from:currentUser.uid,
  to,
  amount:amt,
  status:"pending",
  time:Date.now()
 });
 notice("Payment requested. Await confirmation.");
};

async function fetchUser(uid){
 const s=await fetch(`https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/users/${uid}`);
 return (await s.json()).fields?{upi:(await s.json()).fields.upi.stringValue}:"";
}
</script>
</body>
</html>
